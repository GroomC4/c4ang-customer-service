name: CI

on:
  push:
    branches:
      - main
      - develop
      - 'release/**'
      - 'feature/**'
    tags:
      - 'v*'

jobs:
  continuous-integration:
    name: Run Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          token: ${{ secrets.GROOM_GITHUB_ACTION_TOKEN }}

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run tests
        run: ./gradlew test --no-daemon

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            **/build/test-results/test/*.xml
            **/build/reports/tests/test/

      - name: Publish test report
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Test Results
          path: '**/build/test-results/test/*.xml'
          reporter: java-junit

  call-ecr-push: # 1단계: ECR 푸시 및 태그 추출
    name: Push Docker Image to ECR
    needs: continuous-integration
    if: success() && startsWith(github.ref, 'refs/tags/v')
    permissions:
      id-token: write
      contents: read
    secrets: inherit
    uses: GroomC4/c4ang-platform-core/.github/workflows/reusable-ecr-push.yml@main

  call-config-update: # 2단계: Config 업데이트 (Job 내부에서 직접 실행)
    name: Trigger CD (Update Config Repo)
    runs-on: ubuntu-latest
    needs: call-ecr-push # ECR 푸시가 성공해야 실행
    if: success() && startsWith(github.ref, 'refs/tags/v')

    permissions:
      # c4ang-infra 레포지토리에 커밋하기 위한 권한
      contents: write

    steps:
      - name: Set Variables and Get Image Tag
        run: |
          # 1. 이전 ECR Push Job의 Output에서 이미지 태그를 가져와 환경 변수로 설정
          NEW_TAG=${{ needs.call-ecr-push.outputs.image_tag }}
          echo "NEW_TAG=$NEW_TAG" >> $GITHUB_ENV
          
          # 2. GitHub 레포지토리 이름에서 서비스 슬러그 추출 (예: c4ang-customer-service -> customer-service)
          SERVICE_SLUG=$(echo ${{ github.repository }} | cut -d'/' -f2 | sed 's/c4ang-//')
          echo "SERVICE_SLUG=$SERVICE_SLUG" >> $GITHUB_OUTPUT

      - name: Install yq
        uses: mikefarah/yq@v4

      - name: Checkout Config Repository (c4ang-infra)
        uses: actions/checkout@v4
        with:
          repository: 'GroomC4/c4ang-infra'
          path: config-repo # 클론되는 로컬 디렉토리 이름
          token: ${{ secrets.GROOM_GITHUB_ACTION_TOKEN }}

      - name: Update Helm values.yaml
        working-directory: config-repo # 클론된 'config-repo' 디렉토리 내부에서 작업
        run: |
          SERVICE_SLUG="${{ steps.service_vars.outputs.service_slug }}" 
          VALUES_FILE="helm/services/$SERVICE_SLUG/values.yaml" 
          
          echo "Updating file: $VALUES_FILE with tag: ${{ env.NEW_TAG }}"
          
          # yq를 사용하여 'image.tag' 필드 업데이트
          yq e ".image.tag = \"${{ env.NEW_TAG }}\"" -i $VALUES_FILE

      - name: Commit and Push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          repository: config-repo
          commit_message: "chore(cd): Update $SERVICE_SLUG image to ${{ env.NEW_TAG }} [skip ci]"
          branch: main